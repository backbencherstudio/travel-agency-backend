<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gift Card Purchase Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=AT6CeihhGTOXZboF0RiF-StDE83iZp5VxExAfiVNbzWSkjVQJ5gLtAnXfehv8Nmx82wL1aDgZh1YclAQ&currency=USD"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .loading {
        color: #007bff;
      }
      .test-cards {
        background: #fff3cd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid #ffeeba;
      }
      .gift-card-info {
        background: #e7f3ff;
        padding: 15px;
        margin: 15px 0;
        border-radius: 4px;
        border: 1px solid #b3d9ff;
      }
      #card-element {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-height: 20px;
      }
      #card-errors {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        min-height: 20px;
      }
      .gift-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .gift-card-item {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }
      .gift-card-item:hover {
        border-color: #007bff;
      }
      .gift-card-item.selected {
        border-color: #007bff;
        background-color: #f8f9ff;
      }
      .gift-card-amount {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
      }
      .gift-card-title {
        font-size: 16px;
        margin: 8px 0;
      }
      .gift-card-code {
        font-size: 12px;
        color: #666;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>üéÅ Gift Card Purchase Test Suite</h1>

    <div
      style="
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      "
    >
      <h3>üß™ Test Configuration</h3>
      <div class="form-group">
        <label for="apiUrl">API Base URL:</label>
        <input
          type="text"
          id="apiUrl"
          value="http://localhost:5000"
          placeholder="http://localhost:5000"
        />
      </div>

      <div class="form-group">
        <label for="authToken">Auth Token:</label>
        <input
          type="text"
          id="authToken"
          value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZ21haWwuY29tIiwic3ViIjoiY21lbTdicnI0MDAwMXdzejhseXgyZzhldCIsImlhdCI6MTc1NjAwMjY1OSwiZXhwIjoxNzU2MDg5MDU5fQ.0bt132MWWAnE5H7YsIL4MDnR26smk3uJH6g1I7d_vEk"
          placeholder="Bearer token"
        />
      </div>
    </div>

    <div class="form-group">
      <button onclick="loadGiftCards()" style="background: #17a2b8">
        üîç Load Available Gift Cards
      </button>
    </div>

    <div id="giftCardsContainer" style="display: none">
      <h3>üéÅ Available Gift Cards</h3>
      <div id="giftCardsGrid" class="gift-card-grid"></div>
    </div>

    <div id="selectedGiftCard" style="display: none" class="gift-card-info">
      <h4>Selected Gift Card</h4>
      <div id="selectedCardInfo"></div>
    </div>

    <div class="form-group">
      <label for="quantity">Quantity:</label>
      <input
        type="number"
        id="quantity"
        value="1"
        min="1"
        max="10"
        placeholder="1"
      />
      <small style="color: #666">Number of gift cards to purchase</small>
    </div>

    <div class="form-group">
      <label for="paymentMethod">Payment Method:</label>
      <select id="paymentMethod">
        <option value="stripe">Credit Card (Stripe)</option>
        <option value="paypal">PayPal</option>
        <option value="google_pay">Google Pay</option>
        <option value="apple_pay">Apple Pay</option>
      </select>
      <div id="paymentMethodInfo" class="mt-2 text-muted small"></div>
    </div>

    <button
      onclick="purchaseGiftCard()"
      style="background: #28a745"
      id="purchaseBtn"
      disabled
    >
      üõí Purchase Gift Card
    </button>

    <div class="test-cards">
      <h4>üß™ Test Cards for Stripe:</h4>
      <ul style="margin: 0; padding-left: 20px; font-size: 14px">
        <li>
          <strong>Success:</strong> 4242 4242 4242 4242 (any future date, any
          CVC)
        </li>
        <li><strong>Decline:</strong> 4000 0000 0000 0002</li>
        <li><strong>3D Secure:</strong> 4000 0000 0000 3220</li>
        <li><strong>Insufficient Funds:</strong> 4000 0000 0000 9995</li>
      </ul>
    </div>

    <div id="result"></div>

    <!-- Payment Section -->
    <div id="paymentSection" style="display: none">
      <hr style="margin: 30px 0" />
      <h2>Complete Payment</h2>

      <!-- Card Payment -->
      <div id="card-payment-group" class="form-group">
        <label>Card Details:</label>
        <div id="card-element"></div>
        <div id="card-errors"></div>
      </div>

      <!-- Google Pay / Apple Pay -->
      <div id="prb-payment-group" class="form-group" style="display: none">
        <label>Google Pay / Apple Pay:</label>
        <div id="payment-request-button"></div>
        <div
          id="prb-errors"
          style="color: #dc3545; font-size: 14px; margin-top: 5px"
        ></div>
      </div>

      <!-- PayPal -->
      <div id="paypal-payment-group" class="form-group" style="display: none">
        <label>PayPal:</label>
        <div id="paypal-button-container"></div>
      </div>

      <button
        id="completePaymentBtn"
        onclick="completePayment()"
        style="background: #28a745"
      >
        Complete Payment
      </button>
      <div id="paymentResult"></div>

      <div class="webhook-status" style="margin-top: 20px">
        <h4>üì° Payment Status Check</h4>
        <p>
          After payment completion, check if the payment was processed
          successfully:
        </p>
        <div id="webhookResult" style="margin-top: 10px"></div>
      </div>
    </div>

    <script>
      // Global variables
      let currentClientSecret = null;
      let currentGiftCardId = null;
      let currentPaymentMethod = null;
      let currentPaymentIntentId = null;
      let stripe = null;
      let cardElement = null;
      let paymentRequestButton = null;
      let availableGiftCards = [];

      // Stripe configuration
      const STRIPE_PUBLISHABLE_KEY =
        'pk_test_51RgIDjGbZdiSzPj89wef1vxHaK0jRa4fAUcYFU1KT1mhNBvhgmfwmUWLwaLuV8YEqpae9XdgIwi3cAwHaQ0bxniz00QSaaPJgY';

      // Load available gift cards
      async function loadGiftCards() {
        const resultDiv = document.getElementById('result');
        const giftCardsContainer =
          document.getElementById('giftCardsContainer');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;

        resultDiv.className = 'result loading';
        resultDiv.textContent = 'Loading available gift cards...';

        try {
          const response = await fetch(`${apiUrl}/api/gift-card`, {
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
          });

          const result = await response.json();

          if (result.success) {
            availableGiftCards = result.data;
            displayGiftCards(availableGiftCards);
            giftCardsContainer.style.display = 'block';
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
              <h4>‚úÖ Gift Cards Loaded Successfully!</h4>
              <p><strong>Found:</strong> ${availableGiftCards.length} gift cards</p>
              <p>Select a gift card below to proceed with purchase.</p>
            `;
          } else {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `<h4>‚ùå Failed to Load Gift Cards</h4><p><strong>Error:</strong> ${result.message}</p>`;
          }
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
        }
      }

      // Display gift cards in grid
      function displayGiftCards(giftCards) {
        const grid = document.getElementById('giftCardsGrid');
        grid.innerHTML = '';

        giftCards.forEach((card) => {
          const cardElement = document.createElement('div');
          cardElement.className = 'gift-card-item';
          cardElement.onclick = () => selectGiftCard(card);

          cardElement.innerHTML = `
            <div class="gift-card-amount">$${Number(card.amount)}</div>
            <div class="gift-card-title">${card.title || 'Gift Card'}</div>
            <div class="gift-card-code">${card.code}</div>
          `;

          grid.appendChild(cardElement);
        });
      }

      // Select gift card
      function selectGiftCard(card) {
        // Remove previous selection
        document.querySelectorAll('.gift-card-item').forEach((item) => {
          item.classList.remove('selected');
        });

        // Add selection to clicked item
        event.currentTarget.classList.add('selected');

        currentGiftCardId = card.id;

        // Show selected card info
        const selectedCardDiv = document.getElementById('selectedGiftCard');
        const selectedCardInfo = document.getElementById('selectedCardInfo');

        selectedCardInfo.innerHTML = `
          <p><strong>Title:</strong> ${card.title || 'Gift Card'}</p>
          <p><strong>Amount:</strong> $${Number(card.amount)}</p>
          <p><strong>Currency:</strong> ${card.currency}</p>
          <p><strong>Code:</strong> ${card.code}</p>
          <p><strong>Message:</strong> ${card.message || 'No message'}</p>
          <p><strong>Design:</strong> ${card.design_type}</p>
        `;

        selectedCardDiv.style.display = 'block';
        document.getElementById('purchaseBtn').disabled = false;
      }

      // Update payment method info
      function updatePaymentInfo() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        const infoDiv = document.getElementById('paymentMethodInfo');

        if (infoDiv) {
          switch (paymentMethod) {
            case 'stripe':
              infoDiv.innerHTML = 'üí≥ Credit/Debit Card payment via Stripe';
              break;
            case 'paypal':
              infoDiv.innerHTML = 'üíô PayPal payment';
              break;
            case 'google_pay':
              infoDiv.innerHTML = 'üì± Google Pay via Stripe';
              break;
            case 'apple_pay':
              infoDiv.innerHTML = 'üçé Apple Pay via Stripe';
              break;
            default:
              infoDiv.innerHTML = 'Select a payment method';
          }
        }
      }

      // Initialize Stripe Elements
      function initializeStripeElements() {
        if (!stripe) {
          stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        }

        const elements = stripe.elements();

        // Create card element
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': { color: '#aab7c4' },
            },
            invalid: { color: '#9e2146' },
          },
        });

        // Mount the card element
        cardElement.mount('#card-element');

        // Handle real-time validation errors
        cardElement.on('change', function (event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
      }

      // Initialize payment UI based on selected method
      function initializePaymentUI() {
        const paymentMethod = document.getElementById('paymentMethod').value;
        currentPaymentMethod = paymentMethod;

        // Hide all payment groups initially
        document.getElementById('card-payment-group').style.display = 'none';
        document.getElementById('prb-payment-group').style.display = 'none';
        document.getElementById('paypal-payment-group').style.display = 'none';
        document.getElementById('completePaymentBtn').style.display = 'none';

        switch (paymentMethod) {
          case 'stripe':
            document.getElementById('card-payment-group').style.display =
              'block';
            document.getElementById('completePaymentBtn').style.display =
              'block';
            initializeStripeElements();
            break;
          case 'google_pay':
          case 'apple_pay':
            document.getElementById('prb-payment-group').style.display =
              'block';
            document.getElementById('completePaymentBtn').style.display =
              'block';
            initializePaymentRequestButton(paymentMethod);
            break;
          case 'paypal':
            document.getElementById('paypal-payment-group').style.display =
              'block';
            initializePayPalPayment();
            break;
        }

        updatePaymentInfo();
      }

      // Initialize Google Pay / Apple Pay
      function initializePaymentRequestButton(paymentMethod) {
        if (!stripe) {
          stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        }

        const elements = stripe.elements();
        const quantity = parseInt(document.getElementById('quantity').value);
        const selectedCard = availableGiftCards.find(
          (card) => card.id === currentGiftCardId,
        );
        const totalAmount = Number(selectedCard.amount) * quantity;

        const paymentRequest = stripe.paymentRequest({
          country: 'US',
          currency: 'usd',
          total: {
            label: 'Gift Card Purchase',
            amount: Math.round(totalAmount * 100),
          },
          requestPayerName: true,
          requestPayerEmail: true,
          requestPayerPhone: false,
          requestShipping: false,
          disableWallets: [],
        });

        paymentRequestButton = elements.create('paymentRequestButton', {
          paymentRequest,
        });

        paymentRequest.canMakePayment().then(function (result) {
          if (result) {
            paymentRequestButton.mount('#payment-request-button');
          } else {
            const errorMsg = `${paymentMethod === 'google_pay' ? 'Google Pay' : 'Apple Pay'} is not available on this device/browser.`;
            document.getElementById('prb-errors').textContent = errorMsg;
          }
        });

        paymentRequest.on('paymentmethod', async (ev) => {
          const { error, paymentIntent } = await stripe.confirmPayment({
            clientSecret: currentClientSecret,
            paymentMethod: ev.paymentMethod.id,
            return_url: window.location.href,
          });

          if (error) {
            ev.complete('fail');
            document.getElementById('prb-errors').textContent = error.message;
          } else {
            ev.complete('success');
            currentPaymentIntentId = paymentIntent.id;
            showPaymentSuccess(paymentIntent, paymentMethod);
          }
        });
      }

      // Initialize PayPal
      function initializePayPalPayment() {
        const quantity = parseInt(document.getElementById('quantity').value);
        const selectedCard = availableGiftCards.find(
          (card) => card.id === currentGiftCardId,
        );
        const totalAmount = Number(selectedCard.amount) * quantity;

        paypal
          .Buttons({
            createOrder: function (data, actions) {
              return actions.order.create({
                purchase_units: [
                  {
                    amount: {
                      value: totalAmount.toFixed(2),
                    },
                  },
                ],
              });
            },
            onApprove: function (data, actions) {
              return actions.order.capture().then(function (details) {
                showPaymentSuccess(details, 'paypal');
              });
            },
            onError: function (err) {
              document.getElementById('paymentResult').className =
                'result error';
              document.getElementById('paymentResult').innerHTML =
                `<h4>‚ùå PayPal Payment Error</h4><p><strong>Error:</strong> ${err.message}</p>`;
            },
          })
          .render('#paypal-button-container');
      }

      // Show payment success
      function showPaymentSuccess(paymentData, method) {
        document.getElementById('paymentResult').className = 'result success';
        document.getElementById('paymentResult').innerHTML = `
          <h4>‚úÖ Gift Card Purchase Completed Successfully!</h4>
          <p><strong>Payment Method:</strong> ${method}</p>
          <p><strong>Status:</strong> ${paymentData.status || 'Completed'}</p>
          <div style="background: #d1ecf1; padding: 10px; margin-top: 10px; border-radius: 4px;">
            <strong>üéÅ Your gift card purchase is complete!</strong>
          </div>
        `;
      }

      // Complete payment
      async function completePayment() {
        if (currentPaymentMethod === 'paypal') {
          return; // PayPal handles its own flow
        }

        if (!stripe || !cardElement) {
          alert('Stripe not initialized. Please try again.');
          return;
        }

        if (!currentClientSecret) {
          console.error('Debug: No client secret available');
          console.error('Debug: currentPaymentMethod:', currentPaymentMethod);
          alert('No client secret found. Please try the payment again.');
          return;
        }

        console.log(
          'Debug: About to confirm payment with client secret:',
          currentClientSecret,
        );

        try {
          const result = await stripe.confirmCardPayment(currentClientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: 'Test User',
                email: 'test@example.com',
              },
            },
          });

          if (result.error) {
            alert(`Payment failed: ${result.error.message}`);
          } else {
            showPaymentSuccess(result.paymentIntent, currentPaymentMethod);
          }
        } catch (error) {
          alert(`Payment error: ${error.message}`);
        }
      }

      // Purchase gift card
      async function purchaseGiftCard() {
        const resultDiv = document.getElementById('result');
        const paymentSection = document.getElementById('paymentSection');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;
        const paymentMethod = document.getElementById('paymentMethod').value;
        const quantity = parseInt(document.getElementById('quantity').value);

        if (!currentGiftCardId) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'Please select a gift card first';
          return;
        }

        if (quantity < 1) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'Quantity must be at least 1';
          return;
        }

        const selectedCard = availableGiftCards.find(
          (card) => card.id === currentGiftCardId,
        );
        const totalAmount = Number(selectedCard.amount) * quantity;

        resultDiv.className = 'result loading';
        resultDiv.textContent = `Processing gift card purchase with ${paymentMethod}...`;

        try {
          const requestBody = {
            gift_card_id: currentGiftCardId,
            quantity: quantity,
            payment_method: {
              type: paymentMethod,
              data: {
                amount: totalAmount,
                currency: selectedCard.currency.toLowerCase(),
              },
            },
          };

          const response = await fetch(`${apiUrl}/api/gift-card/purchase`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(requestBody),
          });

          const result = await response.json();

          if (result.success) {
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
              <h4>‚úÖ Gift Card Purchase Initiated!</h4>
              <p><strong>Gift Card:</strong> ${selectedCard.title || 'Gift Card'}</p>
              <p><strong>Quantity:</strong> ${quantity}</p>
              <p><strong>Total Amount:</strong> $${totalAmount}</p>
              <p><strong>Payment Method:</strong> ${paymentMethod}</p>
              <p><strong>Payment Status:</strong> ${result.data.gift_card_purchase.payment_status}</p>
            `;

            // Extract client_secret for Stripe payments
            if (result.data.payment_reference) {
              currentClientSecret = result.data.payment_reference;
              console.log(
                'Debug: Client secret received:',
                currentClientSecret,
              );
            }

            paymentSection.style.display = 'block';
            paymentSection.scrollIntoView({ behavior: 'smooth' });
            initializePaymentUI();
          } else {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `<h4>‚ùå Gift Card Purchase Failed</h4><p><strong>Error:</strong> ${result.message}</p>`;
          }
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
        }
      }

      // Event listeners
      document
        .getElementById('paymentMethod')
        .addEventListener('change', updatePaymentInfo);
      document.addEventListener('DOMContentLoaded', function () {
        updatePaymentInfo();
      });
    </script>
  </body>
</html>
