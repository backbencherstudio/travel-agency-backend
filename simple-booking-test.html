<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Booking Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input,
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 4px;
        white-space: pre-wrap;
      }
      .success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      .loading {
        color: #007bff;
      }
      .test-cards {
        background: #fff3cd;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid #ffeeba;
      }
      .webhook-status {
        background: #d1ecf1;
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border: 1px solid #bee5eb;
      }
      #card-element {
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        min-height: 20px;
      }
      #card-errors {
        color: #dc3545;
        font-size: 14px;
        margin-top: 5px;
        min-height: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Payment System Test Suite</h1>

    <div
      style="
        background: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
      "
    >
      <h3>üß™ Test Configuration</h3>
      <div class="form-group">
        <label for="apiUrl">API Base URL:</label>
        <input
          type="text"
          id="apiUrl"
          value="http://localhost:5000"
          placeholder="http://localhost:5000"
        />
      </div>

      <div class="form-group">
        <label for="authToken">Auth Token:</label>
        <input
          type="text"
          id="authToken"
          value="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6InVzZXJAZ21haWwuY29tIiwic3ViIjoiY21lbTdicnI0MDAwMXdzejhseXgyZzhldCIsImlhdCI6MTc1NjAwMjY1OSwiZXhwIjoxNzU2MDg5MDU5fQ.0bt132MWWAnE5H7YsIL4MDnR26smk3uJH6g1I7d_vEk"
          placeholder="Bearer token"
        />
      </div>
    </div>

    <div class="form-group">
      <label for="checkoutId">Checkout ID:</label>
      <input
        type="text"
        id="checkoutId"
        placeholder="Enter checkout ID or use test mode"
      />
      <button
        onclick="useTestCheckout()"
        style="margin-top: 5px; background: #6c757d"
      >
        Use Test Checkout
      </button>
    </div>

    <div class="form-group">
      <label for="testAmount">Test Amount:</label>
      <input
        type="number"
        id="testAmount"
        value="10.00"
        step="0.01"
        min="0.50"
        placeholder="10.00"
      />
      <small style="color: #666">Minimum $0.50 for Stripe</small>
    </div>

    <div class="form-group">
      <label for="currency">Currency:</label>
      <select id="currency">
        <option value="USD" selected>USD - US Dollar</option>
        <option value="EUR">EUR - Euro</option>
        <option value="GBP">GBP - British Pound</option>
        <option value="CAD">CAD - Canadian Dollar</option>
      </select>
    </div>

    <div class="form-group">
      <label for="bookingType">Booking Type:</label>
      <select id="bookingType">
        <option value="book">Book Now (Immediate Payment)</option>
        <option value="reserve">Reserve (Pay Later)</option>
      </select>
    </div>

    <div class="form-group">
      <label for="paymentMethod">Payment Method:</label>
      <select id="paymentMethod" class="form-control">
        <option value="stripe" selected>Credit Card (Stripe)</option>
      </select>
      <div id="paymentMethodInfo" class="mt-2 text-muted small">
        üí≥ Credit/Debit Card payment via Stripe
      </div>
    </div>

    <button onclick="createBooking()" style="background: #007bff">
      Create Booking & Test Payment
    </button>
    <button
      onclick="checkBookingStatus()"
      style="background: #17a2b8; margin-left: 10px"
    >
      Check Payment Status
    </button>
    <button
      onclick="checkEscrowStatus()"
      style="background: #6f42c1; margin-left: 10px"
    >
      Check Escrow Status
    </button>

    <div class="test-cards">
      <h4>üß™ Test Cards for Stripe:</h4>
      <ul style="margin: 0; padding-left: 20px; font-size: 14px">
        <li>
          <strong>Success:</strong> 4242 4242 4242 4242 (any future date, any
          CVC)
        </li>
        <li><strong>Decline:</strong> 4000 0000 0000 0002</li>
        <li><strong>3D Secure:</strong> 4000 0000 0000 3220</li>
        <li><strong>Insufficient Funds:</strong> 4000 0000 0000 9995</li>
      </ul>
    </div>

    <div id="result"></div>

    <!-- Payment Section -->
    <div id="paymentSection" style="display: none">
      <hr style="margin: 30px 0" />
      <h2>Complete Payment</h2>

      <!-- Card Payment -->
      <div id="card-payment-group" class="form-group">
        <label>Card Details:</label>
        <div id="card-element"></div>
        <div id="card-errors"></div>
      </div>

      <button
        id="completePaymentBtn"
        onclick="completePayment()"
        style="background: #28a745"
      >
        Complete Payment
      </button>
      <div id="paymentResult"></div>

      <div class="webhook-status" style="margin-top: 20px">
        <h4>üì° Payment Status Check</h4>
        <p>
          After payment completion, check if the webhook properly updated the
          booking status:
        </p>
        <div id="webhookResult" style="margin-top: 10px"></div>
      </div>
    </div>

    <!-- Escrow Section -->
    <div id="escrowSection" style="display: none; margin-top: 30px">
      <hr style="margin: 30px 0" />
      <h2>üîí Escrow System</h2>

      <div class="webhook-status" style="margin-top: 20px">
        <h4>üí∞ Escrow Status</h4>
        <div id="escrowStatusResult" style="margin-top: 10px"></div>
      </div>

      <div style="margin-top: 20px">
        <h4>‚úÖ Tour Completion</h4>
        <p>After the tour is completed, confirm it to trigger payout:</p>
        <button
          onclick="confirmTourCompletion()"
          style="background: #28a745; margin-top: 10px"
        >
          Confirm Tour Completion
        </button>
        <div id="confirmResult" style="margin-top: 10px"></div>
      </div>
    </div>

    <script>
      // Global variables
      let currentClientSecret = null;
      let currentBookingId = null;
      let currentPaymentMethod = 'stripe';
      let currentPaymentIntentId = null;
      let stripe = null;
      let cardElement = null;

      // Stripe configuration
      const STRIPE_PUBLISHABLE_KEY =
        'pk_test_51RgIDjGbZdiSzPj89wef1vxHaK0jRa4fAUcYFU1KT1mhNBvhgmfwmUWLwaLuV8YEqpae9XdgIwi3cAwHaQ0bxniz00QSaaPJgY';

      // Initialize Stripe Elements
      function initializeStripeElements() {
        if (!stripe) {
          stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        }

        const elements = stripe.elements();

        // Create card element
        cardElement = elements.create('card', {
          style: {
            base: {
              fontSize: '16px',
              color: '#424770',
              '::placeholder': { color: '#aab7c4' },
            },
            invalid: { color: '#9e2146' },
          },
        });

        // Mount the card element
        cardElement.mount('#card-element');

        // Handle real-time validation errors
        cardElement.on('change', function (event) {
          const displayError = document.getElementById('card-errors');
          if (event.error) {
            displayError.textContent = event.error.message;
          } else {
            displayError.textContent = '';
          }
        });
      }

      // Update payment method info
      function updatePaymentInfo() {
        const infoDiv = document.getElementById('paymentMethodInfo');
        if (infoDiv) {
          infoDiv.innerHTML = 'üí≥ Credit/Debit Card payment via Stripe';
        }
      }

      // Initialize payment UI (Stripe only)
      function initializePaymentUI() {
        currentPaymentMethod = 'stripe';

        // Debug logging
        console.log('Debug: initializePaymentUI called for Stripe payment');
        console.log('Debug: currentClientSecret:', currentClientSecret);
        console.log('Debug: currentPaymentIntentId:', currentPaymentIntentId);

        // Show card payment group and complete button
        document.getElementById('card-payment-group').style.display = 'block';
        document.getElementById('completePaymentBtn').style.display = 'block';

        // Ensure we have the client secret for Stripe payments
        if (!currentClientSecret) {
          console.error('Debug: No client secret available for Stripe payment');
          document.getElementById('card-errors').textContent =
            'Payment not initialized. Please try creating the booking again.';
        } else {
          document.getElementById('card-errors').textContent = '';
        }

        initializeStripeElements();
        updatePaymentInfo();
      }

      // Show payment success
      function showPaymentSuccess(paymentData, method) {
        document.getElementById('paymentResult').className = 'result success';
        document.getElementById('paymentResult').innerHTML = `
          <h4>‚úÖ Payment Completed Successfully!</h4>
          <p><strong>Booking ID:</strong> ${currentBookingId}</p>
          <p><strong>Payment Method:</strong> ${method}</p>
          <p><strong>Status:</strong> ${paymentData.status}</p>
          <div style="background: #d1ecf1; padding: 10px; margin-top: 10px; border-radius: 4px;">
            <strong>üîÑ Next Step:</strong> Check booking status below to verify webhook processing
          </div>
        `;
      }

      // Complete payment (Stripe only)
      async function completePayment() {
        if (!stripe || !cardElement) {
          alert('Stripe not initialized. Please try again.');
          return;
        }

        if (!currentClientSecret) {
          console.error('Debug: currentClientSecret is null/undefined');
          console.error('Debug: currentPaymentMethod:', currentPaymentMethod);
          console.error('Debug: currentBookingId:', currentBookingId);
          alert('No client secret found. Please try the payment again.');
          return;
        }

        try {
          console.log('Debug: Starting Stripe card payment confirmation');
          console.log('Debug: currentClientSecret:', currentClientSecret);
          console.log('Debug: cardElement:', cardElement);

          // For card payments, we need to use confirmCardPayment with the card element
          const result = await stripe.confirmCardPayment(currentClientSecret, {
            payment_method: {
              card: cardElement,
              billing_details: {
                name: 'Test User',
                email: 'test@example.com',
              },
            },
          });

          console.log('Debug: Stripe confirmCardPayment result:', result);

          if (result.error) {
            alert(`Payment failed: ${result.error.message}`);
          } else {
            showPaymentSuccess(result.paymentIntent, 'stripe');
            // Show escrow section after successful payment
            document.getElementById('escrowSection').style.display = 'block';
            document
              .getElementById('escrowSection')
              .scrollIntoView({ behavior: 'smooth' });
            // Auto-check escrow status
            setTimeout(() => {
              checkEscrowStatus();
            }, 2000);
          }
        } catch (error) {
          alert(`Payment error: ${error.message}`);
        }
      }

      // Create booking
      async function createBooking() {
        const resultDiv = document.getElementById('result');
        const paymentSection = document.getElementById('paymentSection');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;
        const checkoutId = document.getElementById('checkoutId').value;
        const bookingType = document.getElementById('bookingType').value;
        const testAmount = parseFloat(
          document.getElementById('testAmount').value,
        );

        if (!checkoutId) {
          resultDiv.className = 'result error';
          resultDiv.textContent =
            'Please enter a checkout ID or click "Use Test Checkout"';
          return;
        }

        if (testAmount < 0.5) {
          resultDiv.className = 'result error';
          resultDiv.textContent = 'Amount must be at least $0.50 for Stripe';
          return;
        }

        resultDiv.className = 'result loading';
        resultDiv.textContent = `Creating booking with Stripe...`;

        try {
          const requestBody = {
            checkout_id: checkoutId,
            booking_type: bookingType,
          };

          if (bookingType === 'book') {
            requestBody.payment_method = {
              type: 'stripe',
              data: {
                amount: testAmount,
                currency: 'usd',
              },
            };
          }

          const response = await fetch(`${apiUrl}/api/booking`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify(requestBody),
          });

          const result = await response.json();

          if (result.success) {
            resultDiv.className = 'result success';
            resultDiv.innerHTML = `
              <h4>‚úÖ Booking Created Successfully!</h4>
              <p><strong>Booking ID:</strong> ${result.data.booking_id}</p>
              <p><strong>Payment Method:</strong> ${result.data.payment_method}</p>
              <p><strong>Payment Status:</strong> ${result.data.payment_status}</p>
              <p><strong>Amount:</strong> $${result.data.final_price}</p>
              ${result.data.client_secret ? `<p><strong>Client Secret:</strong> ${result.data.client_secret.substring(0, 20)}...</p>` : ''}
              ${result.data.payment_intent_id ? `<p><strong>Payment Intent ID:</strong> ${result.data.payment_intent_id}</p>` : ''}
            `;

            currentBookingId = result.data.booking_id;
            currentPaymentMethod = 'stripe';

            // Extract client_secret for Stripe payments
            if (result.data.client_secret) {
              currentClientSecret = result.data.client_secret;
              currentPaymentIntentId = result.data.payment_intent_id;
            }

            if (bookingType === 'book') {
              paymentSection.style.display = 'block';
              paymentSection.scrollIntoView({ behavior: 'smooth' });
              initializePaymentUI();
            }

            // Show escrow section if payment succeeded
            if (result.data.payment_status === 'succeeded') {
              document.getElementById('escrowSection').style.display = 'block';
            }
          } else {
            resultDiv.className = 'result error';
            resultDiv.innerHTML = `<h4>‚ùå Booking Failed</h4><p><strong>Error:</strong> ${result.message}</p>`;
          }
        } catch (error) {
          resultDiv.className = 'result error';
          resultDiv.textContent = `‚ùå Error: ${error.message}`;
        }
      }

      // Check booking status
      async function checkBookingStatus() {
        const webhookResultDiv = document.getElementById('webhookResult');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;

        if (!currentBookingId) {
          webhookResultDiv.className = 'result error';
          webhookResultDiv.textContent =
            'No booking ID available. Create a booking first.';
          return;
        }

        webhookResultDiv.className = 'result loading';
        webhookResultDiv.textContent = 'Checking booking status...';

        try {
          const response = await fetch(
            `${apiUrl}/api/booking/${currentBookingId}`,
            {
              headers: { Authorization: `Bearer ${authToken}` },
            },
          );

          const result = await response.json();

          if (result.success) {
            const booking = result.data;
            webhookResultDiv.className = 'result success';

            // Show escrow section if payment succeeded
            if (booking.payment_status === 'succeeded') {
              document.getElementById('escrowSection').style.display = 'block';
            }

            webhookResultDiv.innerHTML = `
              <h4>üìä Current Booking Status</h4>
              <p><strong>Booking ID:</strong> ${booking.id}</p>
              <p><strong>Status:</strong> ${booking.status || 'N/A'}</p>
              <p><strong>Payment Status:</strong> ${booking.payment_status}</p>
              <p><strong>Escrow Status:</strong> ${booking.escrow_status || 'pending'}</p>
              <p><strong>Final Price:</strong> $${booking.final_price}</p>
              <p><strong>Paid Amount:</strong> $${booking.paid_amount || 'N/A'}</p>
              <p><strong>Payout Schedule:</strong> ${booking.payout_schedule || 'event_based'}</p>
              ${booking.completed_at ? `<p><strong>Completed At:</strong> ${new Date(booking.completed_at).toLocaleString()}</p>` : ''}
              ${booking.client_confirmed_at ? `<p><strong>Client Confirmed At:</strong> ${new Date(booking.client_confirmed_at).toLocaleString()}</p>` : ''}
              <p><strong>Last Updated:</strong> ${new Date(booking.updated_at).toLocaleString()}</p>
              ${booking.payment_status === 'succeeded' ? '<div style="background: #d4edda; padding: 8px; margin-top: 8px; border-radius: 4px;">‚úÖ Payment succeeded! Funds held in escrow.</div>' : '<div style="background: #fff3cd; padding: 8px; margin-top: 8px; border-radius: 4px;">‚è≥ Waiting for payment...</div>'}
              ${booking.escrow_status === 'held' ? '<div style="background: #d1ecf1; padding: 8px; margin-top: 8px; border-radius: 4px;">üîí Funds held in escrow. Waiting for tour completion.</div>' : ''}
              ${booking.escrow_status === 'released_full' ? '<div style="background: #d4edda; padding: 8px; margin-top: 8px; border-radius: 4px;">‚úÖ Funds released to vendor (80%) + Commission (20%)</div>' : ''}
              ${booking.escrow_status === 'released_partial' ? '<div style="background: #fff3cd; padding: 8px; margin-top: 8px; border-radius: 4px;">üí∞ Partial release completed. Waiting for final release.</div>' : ''}
            `;
          } else {
            webhookResultDiv.className = 'result error';
            webhookResultDiv.textContent = `Error: ${result.message}`;
          }
        } catch (error) {
          webhookResultDiv.className = 'result error';
          webhookResultDiv.textContent = `Error checking status: ${error.message}`;
        }
      }

      // Check escrow status
      async function checkEscrowStatus() {
        const escrowResultDiv = document.getElementById('escrowStatusResult');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;

        if (!currentBookingId) {
          escrowResultDiv.className = 'result error';
          escrowResultDiv.textContent =
            'No booking ID available. Create a booking first.';
          return;
        }

        escrowResultDiv.className = 'result loading';
        escrowResultDiv.textContent = 'Checking escrow status...';

        try {
          // First check booking status to get escrow info
          const response = await fetch(
            `${apiUrl}/api/booking/${currentBookingId}`,
            {
              headers: { Authorization: `Bearer ${authToken}` },
            },
          );

          const result = await response.json();

          if (result.success) {
            const booking = result.data;
            escrowResultDiv.className = 'result success';

            const escrowStatus = booking.escrow_status || 'pending';
            const paidAmount = parseFloat(booking.paid_amount || 0);
            const commissionAmount = paidAmount * 0.2; // 20%
            const vendorAmount = paidAmount * 0.8; // 80%

            let statusMessage = '';
            let statusColor = '#fff3cd';

            switch (escrowStatus) {
              case 'pending':
                statusMessage = '‚è≥ Payment pending - Funds not yet in escrow';
                break;
              case 'held':
                statusMessage =
                  'üîí Funds held in escrow - Waiting for tour completion';
                statusColor = '#d1ecf1';
                break;
              case 'released_partial':
                statusMessage =
                  'üí∞ Partial release completed (50% released 30 days before trip)';
                statusColor = '#fff3cd';
                break;
              case 'released_full':
                statusMessage = '‚úÖ Funds fully released to vendor';
                statusColor = '#d4edda';
                break;
              case 'refunded':
                statusMessage = '‚Ü©Ô∏è Funds refunded to client';
                statusColor = '#f8d7da';
                break;
              default:
                statusMessage = `üìä Escrow status: ${escrowStatus}`;
            }

            escrowResultDiv.innerHTML = `
              <h4>üîí Escrow Details</h4>
              <p><strong>Escrow Status:</strong> ${escrowStatus}</p>
              <div style="background: ${statusColor}; padding: 10px; margin-top: 8px; border-radius: 4px;">
                ${statusMessage}
              </div>
              ${
                paidAmount > 0
                  ? `
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                  <h5>üí∞ Payment Breakdown:</h5>
                  <p><strong>Total Paid:</strong> $${paidAmount.toFixed(2)}</p>
                  <p><strong>Vendor Receives (80%):</strong> $${vendorAmount.toFixed(2)}</p>
                  <p><strong>Platform Commission (20%):</strong> $${commissionAmount.toFixed(2)}</p>
                  <p><strong>Payout Schedule:</strong> ${booking.payout_schedule || 'event_based'}</p>
                  ${booking.payout_schedule === 'weekly' ? '<p style="color: #856404; margin-top: 5px;">üìÖ Weekly payout: Every Monday at 9:00 AM</p>' : ''}
                  ${booking.payout_schedule === 'event_based' ? '<p style="color: #856404; margin-top: 5px;">üìÖ Event-based: 50% at 30 days before, 50% after completion</p>' : ''}
                </div>
              `
                  : ''
              }
            `;
          } else {
            escrowResultDiv.className = 'result error';
            escrowResultDiv.textContent = `Error: ${result.message}`;
          }
        } catch (error) {
          escrowResultDiv.className = 'result error';
          escrowResultDiv.textContent = `Error checking escrow status: ${error.message}`;
        }
      }

      // Confirm tour completion
      async function confirmTourCompletion() {
        const confirmResultDiv = document.getElementById('confirmResult');
        const apiUrl = document.getElementById('apiUrl').value;
        const authToken = document.getElementById('authToken').value;

        if (!currentBookingId) {
          confirmResultDiv.className = 'result error';
          confirmResultDiv.textContent =
            'No booking ID available. Create a booking first.';
          return;
        }

        if (
          !confirm(
            'Are you sure you want to confirm tour completion? This will trigger payout for packages.',
          )
        ) {
          return;
        }

        confirmResultDiv.className = 'result loading';
        confirmResultDiv.textContent = 'Confirming tour completion...';

        try {
          const response = await fetch(
            `${apiUrl}/api/booking/${currentBookingId}/confirm`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${authToken}`,
              },
            },
          );

          const result = await response.json();

          if (result.success) {
            confirmResultDiv.className = 'result success';
            confirmResultDiv.innerHTML = `
              <h4>‚úÖ Tour Confirmed Successfully!</h4>
              <p>${result.message}</p>
              <div style="background: #d1ecf1; padding: 10px; margin-top: 10px; border-radius: 4px;">
                <strong>üìÖ Next Steps:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                  <li>For daily tours: Funds will be released on next Monday (weekly payout)</li>
                  <li>For packages: Final release will be processed automatically</li>
                </ul>
              </div>
            `;

            // Refresh booking status
            setTimeout(() => {
              checkBookingStatus();
              checkEscrowStatus();
            }, 1000);
          } else {
            confirmResultDiv.className = 'result error';
            confirmResultDiv.innerHTML = `<h4>‚ùå Confirmation Failed</h4><p>${result.message}</p>`;
          }
        } catch (error) {
          confirmResultDiv.className = 'result error';
          confirmResultDiv.textContent = `Error: ${error.message}`;
        }
      }

      // Use test checkout
      function useTestCheckout() {
        document.getElementById('checkoutId').value =
          'test-checkout-' + Date.now();
      }

      // Event listeners
      document.addEventListener('DOMContentLoaded', function () {
        updatePaymentInfo();
        useTestCheckout();
      });
    </script>
  </body>
</html>
